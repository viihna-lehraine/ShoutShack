import Fastify from 'fastify';
import './config/loadEnv';
import routes from './routes/routes.js';
const fastify = Fastify({
    logger: {
        level: 'debug',
        transport: {
            target: 'pino-pretty',
            options: {
                destination: '../logs/fastify.log'
            }
        }
    }
});
if (!process.env.SERVER_PORT || isNaN(parseInt(process.env.SERVER_PORT, 10))) {
    console.error('SERVER_PORT is malformed or undefined. Check .env file.');
    process.exit(1);
}
const SERVER_PORT = parseInt(process.env.SERVER_PORT, 10) || 3050;
fastify.addHook('onClose', (instance, done) => {
    console.log('Fastify is shutting down...');
    done();
});
process.on('uncaughtException', (err) => {
    console.error('Uncaught exception:', err);
});
process.on('unhandledRejection', (err) => {
    console.error('Unhandled rejection:', err);
});
process.on('SIGINT', () => {
    console.log('Received SIGINT. Graceful shutdown...');
    fastify.close().then(() => process.exit(0));
});
process.on('SIGTERM', () => {
    console.log('Received SIGTERM. Graceful shutdown...');
    fastify.close().then(() => process.exit(0));
});
routes(fastify);
const start = async () => {
    try {
        await fastify.listen({ port: SERVER_PORT });
        console.log(`Server running at http://localhost:${SERVER_PORT}}`);
    }
    catch (err) {
        console.error('Failed to start the server:', err);
        fastify.log.error(err);
        process.exit(1);
    }
};
start();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLE1BQU0sTUFBTSxpQkFBaUIsQ0FBQztBQUVyQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDcEIsTUFBTSxFQUFFO1FBQ0osS0FBSyxFQUFFLE9BQU87UUFDZCxTQUFTLEVBQUU7WUFDUCxNQUFNLEVBQUUsYUFBYTtZQUNyQixPQUFPLEVBQUU7Z0JBQ0wsV0FBVyxFQUFFLHFCQUFxQjthQUNyQztTQUNKO0tBQ0o7Q0FDSixDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDOUUsT0FBTyxDQUFDLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO0lBQ3pFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUM7QUFFbEUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDN0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQzNDLElBQUksRUFBRSxDQUFDO0FBQ1IsQ0FBQyxDQUFDLENBQUE7QUFFRixPQUFPLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7SUFDcEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQztBQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtJQUNyQyxPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQy9DLENBQUMsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO0lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLENBQUMsQ0FBQztJQUNyRCxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoRCxDQUFDLENBQUMsQ0FBQztBQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRTtJQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7SUFDdEQsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFaEIsTUFBTSxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDckIsSUFBSSxDQUFDO1FBQ0QsTUFBTSxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDNUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBR0YsS0FBSyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRmFzdGlmeSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCAnLi9jb25maWcvbG9hZEVudic7XG5pbXBvcnQgcm91dGVzIGZyb20gJy4vcm91dGVzL3JvdXRlcyc7XG5cbmNvbnN0IGZhc3RpZnkgPSBGYXN0aWZ5KHtcbiAgICBsb2dnZXI6IHtcbiAgICAgICAgbGV2ZWw6ICdkZWJ1ZycsXG4gICAgICAgIHRyYW5zcG9ydDoge1xuICAgICAgICAgICAgdGFyZ2V0OiAncGluby1wcmV0dHknLFxuICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uOiAnLi4vbG9ncy9mYXN0aWZ5LmxvZydcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5pZiAoIXByb2Nlc3MuZW52LlNFUlZFUl9QT1JUIHx8IGlzTmFOKHBhcnNlSW50KHByb2Nlc3MuZW52LlNFUlZFUl9QT1JULCAxMCkpKSB7XG5cdGNvbnNvbGUuZXJyb3IoJ1NFUlZFUl9QT1JUIGlzIG1hbGZvcm1lZCBvciB1bmRlZmluZWQuIENoZWNrIC5lbnYgZmlsZS4nKTtcblx0cHJvY2Vzcy5leGl0KDEpO1xufVxuXG5jb25zdCBTRVJWRVJfUE9SVCA9IHBhcnNlSW50KHByb2Nlc3MuZW52LlNFUlZFUl9QT1JULCAxMCkgfHwgMzA1MDtcblxuZmFzdGlmeS5hZGRIb29rKCdvbkNsb3NlJywgKGluc3RhbmNlLCBkb25lKSA9PiB7XG5cdGNvbnNvbGUubG9nKCdGYXN0aWZ5IGlzIHNodXR0aW5nIGRvd24uLi4nKTtcblx0ZG9uZSgpO1xufSlcblxucHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignVW5jYXVnaHQgZXhjZXB0aW9uOicsIGVycik7XG59KTtcblxucHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKGVycikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1VuaGFuZGxlZCByZWplY3Rpb246JywgZXJyKTtcbn0pO1xuXG5wcm9jZXNzLm9uKCdTSUdJTlQnLCAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1JlY2VpdmVkIFNJR0lOVC4gR3JhY2VmdWwgc2h1dGRvd24uLi4nKTtcbiAgICBmYXN0aWZ5LmNsb3NlKCkudGhlbigoKSA9PiBwcm9jZXNzLmV4aXQoMCkpO1xufSk7XG5cbnByb2Nlc3Mub24oJ1NJR1RFUk0nLCAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1JlY2VpdmVkIFNJR1RFUk0uIEdyYWNlZnVsIHNodXRkb3duLi4uJyk7XG4gICAgZmFzdGlmeS5jbG9zZSgpLnRoZW4oKCkgPT4gcHJvY2Vzcy5leGl0KDApKTtcbn0pO1xuXG5yb3V0ZXMoZmFzdGlmeSk7XG5cbmNvbnN0IHN0YXJ0ID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZhc3RpZnkubGlzdGVuKHsgcG9ydDogU0VSVkVSX1BPUlQgfSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBTZXJ2ZXIgcnVubmluZyBhdCBodHRwOi8vbG9jYWxob3N0OiR7U0VSVkVSX1BPUlR9fWApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc3RhcnQgdGhlIHNlcnZlcjonLCBlcnIpO1xuICAgICAgICBmYXN0aWZ5LmxvZy5lcnJvcihlcnIpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfVxufTtcblxuXG5zdGFydCgpO1xuIl19