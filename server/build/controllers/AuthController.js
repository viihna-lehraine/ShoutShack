// File: server/src/controllers/AuthController.ts
import { sendVerificationEmail } from '../services/mailer.js';
import argon2 from 'argon2';
import { UserRepository } from '../db/repositories/UserRepository.js';
import { z } from 'zod';
const signupSchema = z.object({
    email: z.string().email(),
    password: z.string().min(8, 'Password must be at least 8 characters long')
});
const loginSchema = z.object({
    email: z.string().email(),
    password: z.string()
});
export class AuthController {
    static async signup(request, reply) {
        try {
            const { email, password } = signupSchema.parse(request.body);
            const existingUser = await UserRepository.findUserByEmail(email);
            if (existingUser) {
                return reply.status(400).send({ error: 'Email already in use' });
            }
            const hashedPassword = await argon2.hash(password, { type: argon2.argon2id });
            const token = await UserRepository.createUser(email, hashedPassword);
            await sendVerificationEmail(email, token);
            return reply.send({ message: 'User registered! Check your email for verification.' });
        }
        catch (error) {
            if (error instanceof z.ZodError) {
                return reply.status(400).send({ error: 'Invalid input', details: error.errors });
            }
            console.error('Signup Error:', error);
            return reply.status(500).send({ error: 'Internal server error' });
        }
    }
    static async verify(request, reply) {
        try {
            const { token } = request.query;
            if (!token) {
                return reply.status(400).send({ error: 'Missing verification token' });
            }
            const user = await UserRepository.verifyUser(token);
            if (!user) {
                return reply.status(400).send({ error: 'Invalid or expired token' });
            }
            return reply.send({ message: 'Email verified successfully! You can now log in.' });
        }
        catch (error) {
            console.error('Verification Error:', error);
            return reply.status(500).send({ error: 'Internal server error' });
        }
    }
    static async login(request, reply) {
        try {
            const { email, password } = loginSchema.parse(request.body);
            const user = await UserRepository.findUserByEmail(email);
            if (!user) {
                return reply.status(401).send({ error: 'Invalid email or password' });
            }
            const isValid = await argon2.verify(user.password, password);
            if (!isValid) {
                return reply.status(401).send({ error: 'Invalid email or password' });
            }
            const token = request.server.jwt.sign({ userId: user.id });
            return reply.send({ message: 'Login successful', token });
        }
        catch (error) {
            if (error instanceof z.ZodError) {
                return reply.status(400).send({ error: 'Invalid input', details: error.errors });
            }
            console.error('Login Error:', error);
            return reply.status(500).send({ error: 'Internal server error' });
        }
    }
    static async getProfile(request, reply) {
        try {
            const userId = request.user?.userId;
            if (!userId) {
                return reply.status(401).send({ error: 'Unauthorized' });
            }
            const user = await UserRepository.getUserProfile(userId);
            if (!user) {
                return reply.status(404).send({ error: 'User not found' });
            }
            return reply.send(user);
        }
        catch (error) {
            console.error('Profile Error:', error);
            return reply.status(500).send({ error: 'Internal server error' });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aENvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29udHJvbGxlcnMvQXV0aENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsaURBQWlEO0FBR2pELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlELE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdEUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUV4QixNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzdCLEtBQUssRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFO0lBQ3pCLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSw2Q0FBNkMsQ0FBQztDQUMxRSxDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzVCLEtBQUssRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFO0lBQ3pCLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO0NBQ3BCLENBQUMsQ0FBQztBQUVILE1BQU0sT0FBTyxjQUFjO0lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQXVCLEVBQUUsS0FBbUI7UUFDL0QsSUFBSSxDQUFDO1lBQ0osTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3RCxNQUFNLFlBQVksR0FBRyxNQUFNLGNBQWMsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFakUsSUFBSSxZQUFZLEVBQUUsQ0FBQztnQkFDbEIsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxzQkFBc0IsRUFBRSxDQUFDLENBQUM7WUFDbEUsQ0FBQztZQUVELE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDOUUsTUFBTSxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxjQUFjLENBQUMsQ0FBQztZQUVyRSxNQUFNLHFCQUFxQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztZQUUxQyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUscURBQXFELEVBQUUsQ0FBQyxDQUFDO1FBQ3ZGLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDakMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQ2xGLENBQUM7WUFDRCxPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN0QyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO0lBQ0YsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQXVCLEVBQUUsS0FBbUI7UUFDL0QsSUFBSSxDQUFDO1lBQ0osTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE9BQU8sQ0FBQyxLQUEwQixDQUFDO1lBRXJELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDWixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDRCQUE0QixFQUFFLENBQUMsQ0FBQztZQUN4RSxDQUFDO1lBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFjLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDWCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDBCQUEwQixFQUFFLENBQUMsQ0FBQztZQUN0RSxDQUFDO1lBRUQsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLGtEQUFrRCxFQUFFLENBQUMsQ0FBQztRQUNwRixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVDLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLENBQUM7SUFDRixDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBdUIsRUFBRSxLQUFtQjtRQUM5RCxJQUFJLENBQUM7WUFDSixNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVELE1BQU0sSUFBSSxHQUFHLE1BQU0sY0FBYyxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV6RCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1gsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSwyQkFBMkIsRUFBRSxDQUFDLENBQUM7WUFDdkUsQ0FBQztZQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRTdELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDZCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDJCQUEyQixFQUFFLENBQUMsQ0FBQztZQUN2RSxDQUFDO1lBRUQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRTNELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDakMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQ2xGLENBQUM7WUFDRCxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNyQyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO0lBQ0YsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXVCLEVBQUUsS0FBbUI7UUFDbkUsSUFBSSxDQUFDO1lBQ0osTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUM7WUFDcEMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNiLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztZQUMxRCxDQUFDO1lBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFjLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3pELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDWCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztZQUM1RCxDQUFDO1lBRUQsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztJQUNGLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHNlcnZlci9zcmMvY29udHJvbGxlcnMvQXV0aENvbnRyb2xsZXIudHNcblxuaW1wb3J0IHsgRmFzdGlmeVJlcGx5LCBGYXN0aWZ5UmVxdWVzdCB9IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IHsgc2VuZFZlcmlmaWNhdGlvbkVtYWlsIH0gZnJvbSAnLi4vc2VydmljZXMvbWFpbGVyLmpzJztcbmltcG9ydCBhcmdvbjIgZnJvbSAnYXJnb24yJztcbmltcG9ydCB7IFVzZXJSZXBvc2l0b3J5IH0gZnJvbSAnLi4vZGIvcmVwb3NpdG9yaWVzL1VzZXJSZXBvc2l0b3J5LmpzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5jb25zdCBzaWdudXBTY2hlbWEgPSB6Lm9iamVjdCh7XG5cdGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXG5cdHBhc3N3b3JkOiB6LnN0cmluZygpLm1pbig4LCAnUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA4IGNoYXJhY3RlcnMgbG9uZycpXG59KTtcblxuY29uc3QgbG9naW5TY2hlbWEgPSB6Lm9iamVjdCh7XG5cdGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXG5cdHBhc3N3b3JkOiB6LnN0cmluZygpXG59KTtcblxuZXhwb3J0IGNsYXNzIEF1dGhDb250cm9sbGVyIHtcblx0c3RhdGljIGFzeW5jIHNpZ251cChyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgcmVwbHk6IEZhc3RpZnlSZXBseSkge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gc2lnbnVwU2NoZW1hLnBhcnNlKHJlcXVlc3QuYm9keSk7XG5cdFx0XHRjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCBVc2VyUmVwb3NpdG9yeS5maW5kVXNlckJ5RW1haWwoZW1haWwpO1xuXG5cdFx0XHRpZiAoZXhpc3RpbmdVc2VyKSB7XG5cdFx0XHRcdHJldHVybiByZXBseS5zdGF0dXMoNDAwKS5zZW5kKHsgZXJyb3I6ICdFbWFpbCBhbHJlYWR5IGluIHVzZScgfSk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgYXJnb24yLmhhc2gocGFzc3dvcmQsIHsgdHlwZTogYXJnb24yLmFyZ29uMmlkIH0pO1xuXHRcdFx0Y29uc3QgdG9rZW4gPSBhd2FpdCBVc2VyUmVwb3NpdG9yeS5jcmVhdGVVc2VyKGVtYWlsLCBoYXNoZWRQYXNzd29yZCk7XG5cblx0XHRcdGF3YWl0IHNlbmRWZXJpZmljYXRpb25FbWFpbChlbWFpbCwgdG9rZW4pO1xuXG5cdFx0XHRyZXR1cm4gcmVwbHkuc2VuZCh7IG1lc3NhZ2U6ICdVc2VyIHJlZ2lzdGVyZWQhIENoZWNrIHlvdXIgZW1haWwgZm9yIHZlcmlmaWNhdGlvbi4nIH0pO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG5cdFx0XHRcdHJldHVybiByZXBseS5zdGF0dXMoNDAwKS5zZW5kKHsgZXJyb3I6ICdJbnZhbGlkIGlucHV0JywgZGV0YWlsczogZXJyb3IuZXJyb3JzIH0pO1xuXHRcdFx0fVxuXHRcdFx0Y29uc29sZS5lcnJvcignU2lnbnVwIEVycm9yOicsIGVycm9yKTtcblx0XHRcdHJldHVybiByZXBseS5zdGF0dXMoNTAwKS5zZW5kKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHRcdH1cblx0fVxuXG5cdHN0YXRpYyBhc3luYyB2ZXJpZnkocmVxdWVzdDogRmFzdGlmeVJlcXVlc3QsIHJlcGx5OiBGYXN0aWZ5UmVwbHkpIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgeyB0b2tlbiB9ID0gcmVxdWVzdC5xdWVyeSBhcyB7IHRva2VuOiBzdHJpbmcgfTtcblxuXHRcdFx0aWYgKCF0b2tlbikge1xuXHRcdFx0XHRyZXR1cm4gcmVwbHkuc3RhdHVzKDQwMCkuc2VuZCh7IGVycm9yOiAnTWlzc2luZyB2ZXJpZmljYXRpb24gdG9rZW4nIH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlclJlcG9zaXRvcnkudmVyaWZ5VXNlcih0b2tlbik7XG5cdFx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdFx0cmV0dXJuIHJlcGx5LnN0YXR1cyg0MDApLnNlbmQoeyBlcnJvcjogJ0ludmFsaWQgb3IgZXhwaXJlZCB0b2tlbicgfSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiByZXBseS5zZW5kKHsgbWVzc2FnZTogJ0VtYWlsIHZlcmlmaWVkIHN1Y2Nlc3NmdWxseSEgWW91IGNhbiBub3cgbG9nIGluLicgfSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ1ZlcmlmaWNhdGlvbiBFcnJvcjonLCBlcnJvcik7XG5cdFx0XHRyZXR1cm4gcmVwbHkuc3RhdHVzKDUwMCkuc2VuZCh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgYXN5bmMgbG9naW4ocmVxdWVzdDogRmFzdGlmeVJlcXVlc3QsIHJlcGx5OiBGYXN0aWZ5UmVwbHkpIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgeyBlbWFpbCwgcGFzc3dvcmQgfSA9IGxvZ2luU2NoZW1hLnBhcnNlKHJlcXVlc3QuYm9keSk7XG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlclJlcG9zaXRvcnkuZmluZFVzZXJCeUVtYWlsKGVtYWlsKTtcblxuXHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdHJldHVybiByZXBseS5zdGF0dXMoNDAxKS5zZW5kKHsgZXJyb3I6ICdJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkJyB9KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgaXNWYWxpZCA9IGF3YWl0IGFyZ29uMi52ZXJpZnkodXNlci5wYXNzd29yZCwgcGFzc3dvcmQpO1xuXG5cdFx0XHRpZiAoIWlzVmFsaWQpIHtcblx0XHRcdFx0cmV0dXJuIHJlcGx5LnN0YXR1cyg0MDEpLnNlbmQoeyBlcnJvcjogJ0ludmFsaWQgZW1haWwgb3IgcGFzc3dvcmQnIH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB0b2tlbiA9IHJlcXVlc3Quc2VydmVyLmp3dC5zaWduKHsgdXNlcklkOiB1c2VyLmlkIH0pO1xuXG5cdFx0XHRyZXR1cm4gcmVwbHkuc2VuZCh7IG1lc3NhZ2U6ICdMb2dpbiBzdWNjZXNzZnVsJywgdG9rZW4gfSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmIChlcnJvciBpbnN0YW5jZW9mIHouWm9kRXJyb3IpIHtcblx0XHRcdFx0cmV0dXJuIHJlcGx5LnN0YXR1cyg0MDApLnNlbmQoeyBlcnJvcjogJ0ludmFsaWQgaW5wdXQnLCBkZXRhaWxzOiBlcnJvci5lcnJvcnMgfSk7XG5cdFx0XHR9XG5cdFx0XHRjb25zb2xlLmVycm9yKCdMb2dpbiBFcnJvcjonLCBlcnJvcik7XG5cdFx0XHRyZXR1cm4gcmVwbHkuc3RhdHVzKDUwMCkuc2VuZCh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgYXN5bmMgZ2V0UHJvZmlsZShyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgcmVwbHk6IEZhc3RpZnlSZXBseSkge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB1c2VySWQgPSByZXF1ZXN0LnVzZXI/LnVzZXJJZDtcblx0XHRcdGlmICghdXNlcklkKSB7XG5cdFx0XHRcdHJldHVybiByZXBseS5zdGF0dXMoNDAxKS5zZW5kKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlclJlcG9zaXRvcnkuZ2V0VXNlclByb2ZpbGUodXNlcklkKTtcblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRyZXR1cm4gcmVwbHkuc3RhdHVzKDQwNCkuc2VuZCh7IGVycm9yOiAnVXNlciBub3QgZm91bmQnIH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gcmVwbHkuc2VuZCh1c2VyKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcignUHJvZmlsZSBFcnJvcjonLCBlcnJvcik7XG5cdFx0XHRyZXR1cm4gcmVwbHkuc3RhdHVzKDUwMCkuc2VuZCh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==